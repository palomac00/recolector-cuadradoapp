name: Recolector LÃ­nea 141 (3 paradas)

on:
  schedule:
    - cron: '*/10 * * * *'  # Cada 10 minutos
  workflow_dispatch:  # BotÃ³n manual

jobs:
  parse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl requests pytz

      - name: Crear data/
        run: mkdir -p data

      - name: Fetch Cuadrado API data
        run: |
          # Build the query JSON and URL-encode it
          QUERY1='{"id":"LP1912","lineas":[{"codigo":141,"empresa":"9DJ"}]}'
          QUERY2='{"id":"L6173","lineas":[{"codigo":141,"empresa":"9DJ"}]}'
          QUERY3='{"id":"L6203","lineas":[{"codigo":141,"empresa":"9DJ"}]}'
          
          curl -s "https://cuadrado.com.ar/api/get-parada?query=$(echo -n "$QUERY1" | jq -sRr @uri)" > lp1912.json
          curl -s "https://cuadrado.com.ar/api/get-parada?query=$(echo -n "$QUERY2" | jq -sRr @uri)" > l6173.json
          curl -s "https://cuadrado.com.ar/api/get-parada?query=$(echo -n "$QUERY3" | jq -sRr @uri)" > l6203.json
          
          echo "âœ… Files downloaded:"
          ls -lh *.json

      - name: Merge JSON files
        run: |
          cat > merge.py << 'EOF'
          import json
          files = ['lp1912.json', 'l6173.json', 'l6203.json']
          all_arribos = []
          for f in files:
              try:
                  with open(f, 'r') as file:
                      data = json.load(file)
                      if 'arribos' in data:
                          all_arribos.extend(data['arribos'])
                      print(f"âœ… {f}: {len(data.get('arribos', []))} arribos")
              except Exception as e:
                  print(f"âš ï¸ {f}: {e}")
          
          all_arribos.sort(key=lambda x: x['tiempo'])
          with open('input.json', 'w') as f:
              json.dump({'arribos': all_arribos}, f)
          print(f"âœ… {len(all_arribos)} horarios combinados totales")
          EOF
          python3 merge.py

      - name: Parsear JSON â†’ Excel + TXT
        run: python parse_json.py input.json

      - name: Commit results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ðŸ“Š Arribos 141 actualizados - ${{ github.run_number }}'
          file_pattern: data/*
