name: ðŸšŒ Recolector LÃ­nea 141 (Cuadrado)

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  recolectar:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl requests pytz

      - name: Create data/ directory
        run: mkdir -p data

      - name: Fetch Cuadrado API data
        run: |
          QUERY1='{"id":"LP1912","lineas":[{"codigo":141,"empresa":"9DJ"}]}'
          QUERY2='{"id":"L6173","lineas":[{"codigo":141,"empresa":"9DJ"}]}'
          QUERY3='{"id":"L6203","lineas":[{"codigo":141,"empresa":"9DJ"}]}'
          
          curl -s "https://cuadrado.com.ar/api/get-parada?query=$(echo -n "$QUERY1" | jq -sRr @uri)" > lp1912.json
          curl -s "https://cuadrado.com.ar/api/get-parada?query=$(echo -n "$QUERY2" | jq -sRr @uri)" > l6173.json
          curl -s "https://cuadrado.com.ar/api/get-parada?query=$(echo -n "$QUERY3" | jq -sRr @uri)" > l6203.json
          
          echo "âœ… API data fetched"
          ls -lh *.json

      - name: Merge JSON files
        run: |
          python3 << 'PYEOF'
          import json
          
          paradas_map = {
              'lp1912.json': 'LP1912',
              'l6173.json': 'L6173',
              'l6203.json': 'L6203'
          }
          
          files = ['lp1912.json', 'l6173.json', 'l6203.json']
          all_arribos = []
          
          for f in files:
              try:
                  with open(f, 'r') as file:
                      data = json.load(file)
                      parada_name = paradas_map.get(f, 'UNKNOWN')
                      
                      if 'arribos' in data:
                          for arribo in data['arribos']:
                              arribo['parada'] = parada_name
                              all_arribos.append(arribo)
                          print(f"âœ… {f}: {len(data.get('arribos', []))} arribos ({parada_name})")
              except Exception as e:
                  print(f"âš ï¸ {f}: {e}")
          
          all_arribos.sort(key=lambda x: x['tiempo'])
          
          print("\n=== DEBUG: Primeros 3 arribos ===")
          for arr in all_arribos[:3]:
              print(f"Parada: {arr.get('parada')}, Bandera: {arr.get('bandera')}")
          
          with open('input.json', 'w') as f:
              json.dump({'arribos': all_arribos}, f)
          print(f"âœ… {len(all_arribos)} total horarios merged")
          PYEOF

      - name: Parse JSON â†’ Excel + TXT
        run: |
          python parse_json.py input.json
          echo "âœ… Parse completado"
          ls -lh data/

      - name: Auto commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ“Š Horarios actualizados LÃ­nea 141 - ${{ github.run_number }}"
          file_pattern: 'data/*'
